from icalendar import Calendar, Event
import datetime
import pytz
import ask

# ===== 参数设定 =====
semester_start_single = datetime.date(2025, 10, 13)  # 单周起始周一
semester_start_double = semester_start_single + datetime.timedelta(days=7)  # 双周起始从下一周一开始
tz = pytz.timezone("Asia/Shanghai")

# ===== 你的作息表（带午睡改 12:5167 起始） =====
single_week = {
    "周一": [
        (0.0, 7.5, "睡眠"),
        (7.5, 8.1667, "起床/洗漱/通勤"),
        (8.5, 12.1667, "程序设计基础Ⅰ · 天山堂 A414"),
        (12.1667, 12.5, "午餐"),
        (12.5167, 12.9167, "午睡"),
        (14.5, 18.1667, "思想道德与法治 · 天山堂 B501"),
        (18.1667, 18.6667, "晚餐"),
        (19.0, 20.6667, "体育（1/4） · 东区运动场"),
        (21.0, 21.5, "跑步"),
        (21.5, 22.0, "洗澡/护肤"),
        (22.0, 23.5, "自习/复习"),
    ],
    "周二": [
        (0.0, 7.5, "睡眠"),
        (7.5, 8.1667, "起床/洗漱/通勤"),
        (12.1667, 12.5, "午餐"),
        (12.5167, 12.9167, "午睡"),
        (14.5, 18.1667, "普通物理（理工版） · 天山堂 A501"),
        (16.5, 18.1667, "程序设计基础Ⅰ · 天山堂 A606"),
        (19.0, 21.5833, "程序设计基础Ⅱ · 陇山堂 B209"),
        (21.0, 21.5, "娱乐"),
        (21.5, 22.0, "洗漱/护肤"),
        (22.0, 23.5, "预习/阅读"),
    ],
    "周三": [
        (0.0, 7.5, "睡眠"),
        (7.5, 8.1667, "起床/洗漱/通勤"),
        (8.5, 10.1667, "高阶英语Ⅰ · 天山堂 A401"),
        (12.1667, 12.5, "午餐"),
        (12.5167, 12.9167, "午睡"),
        (14.5, 18.1667, "高等数学（同济版）B(1) · 天山堂 A201"),
        (19.0, 20.6667, "思想道德与法治（单周） · 天山堂 B501"),
        (21.0, 21.5, "跑步"),
        (21.5, 22.0, "洗澡/护肤"),
        (22.0, 23.5, "自习/放松"),
    ],
    "周四": [
        (0.0, 7.5, "睡眠"),
        (7.5, 8.1667, "起床/洗漱/通勤"),
        (12.1667, 12.5, "午餐"),
        (12.5167, 12.9167, "午睡"),
        (18.1667, 18.6667, "晚餐"),
        (19.0, 20.6667, "信息科学导论 · 陇山堂 B212"),
        (21.0, 21.5, "娱乐"),
        (21.5, 22.0, "洗澡/护肤"),
        (22.0, 23.5, "阅读"),
    ],
    "周五": [
        (0.0, 7.5, "睡眠"),
        (7.5, 8.1667, "起床/洗漱/通勤"),
        (10.5, 12.1667, "高等数学（同济版）B(1) · 天山堂 A201"),
        (12.1667, 12.5, "午餐"),
        (12.5167, 12.9167, "午睡"),
        (14.5, 16.1667, "普通物理（理工版） · 天山堂 A501"),
        (18.1667, 18.6667, "晚餐"),
        (21.0, 21.5, "跑步"),
        (21.5, 22.0, "洗澡/护肤"),
        (22.0, 23.5, "看电影/放松"),
    ],
    "周六": [
        (0.0, 7.5, "睡眠"),
        (7.5, 8.1667, "起床/洗漱/早餐"),
        (8.5, 12.0, "自由活动（上午）"),
        (12.1667, 12.5, "午餐"),
        (12.5167, 12.9167, "午睡"),
        (13.0, 17.5, "娱乐/出行/打球"),
        (18.0, 18.6667, "晚餐"),
        (21.0, 21.5, "跑步"),
        (21.5, 22.0, "洗澡/护肤"),
        (22.0, 23.5, "阅读/放松"),
    ],
    "周日": [
        (0.0, 7.5, "睡眠"),
        (7.5, 8.0, "起床/洗漱/早餐"),
        (8.5, 12.0, "复习/预习"),
        (12.1667, 12.5, "午餐"),
        (12.5167, 12.9167, "午睡"),
        (13.0, 17.5, "娱乐/学习平衡"),
        (18.0, 18.6667, "晚餐"),
        (19.0, 21.0, "娱乐"),
        (21.5, 22.0, "洗漱/护肤"),
        (22.0, 23.5, "总结一周/规划"),
    ],
}

double_week = {
    "周一": [
        (0.0, 7.5, "睡眠"),
        (7.5, 8.1667, "起床/洗漱/通勤"),
        (8.5, 10.1667, "高阶英语Ⅰ · 天山堂 A401"),
        (12.1667, 12.5, "午餐"),
        (12.5167, 12.9167, "午睡"),
        (14.5, 18.1667, "思想道德与法治 · 天山堂 B501"),
        (19.0, 20.6667, "体育（1/4） · 东区运动场"),
        (21.0, 21.5, "跑步"),
        (21.5, 22.0, "洗澡/护肤"),
        (22.0, 23.5, "自习/放松"),
    ],
    "周二": [
        (0.0, 7.5, "睡眠"),
        (7.5, 8.1667, "起床/洗漱/通勤"),
        (12.1667, 12.5, "午餐"),
        (12.5167, 12.9167, "午睡"),
        (14.5, 18.1667, "普通物理（理工版） · 天山堂 A501"),
        (16.5, 18.1667, "程序设计基础Ⅰ · 天山堂 A606"),
        (19.0, 21.5833, "程序设计基础Ⅱ · 陇山堂 B209"),
        (21.0, 21.5, "娱乐"),
        (21.5, 22.0, "洗漱/护肤"),
        (22.0, 23.5, "阅读/自习"),
    ],
    "周三": [
        (0.0, 7.5, "睡眠"),
        (7.5, 8.1667, "起床/洗漱/通勤"),
        (12.1667, 12.5, "午餐"),
        (12.5167, 12.9167, "午睡"),
        (14.5, 18.1667, "高等数学（同济版）B(1) · 天山堂 A201"),
        (18.1667, 18.6667, "晚餐"),
        (19.0, 19.5, "娱乐"),
        (21.0, 21.5, "跑步"),
        (21.5, 22.0, "洗澡/护肤"),
        (22.0, 23.5, "学习"),
    ],
    "周四": [
        (0.0, 7.5, "睡眠"),
        (7.5, 8.1667, "起床/洗漱/通勤"),
        (12.1667, 12.5, "午餐"),
        (12.5167, 12.9167, "午睡"),
        (18.1667, 18.6667, "晚餐"),
        (19.0, 20.6667, "信息科学导论 · 陇山堂 B212"),
        (21.5, 22.0, "洗澡/护肤"),
        (22.0, 23.5, "阅读"),
    ],
    "周五": [
        (0.0, 7.5, "睡眠"),
        (7.5, 8.1667, "起床/洗漱/通勤"),
        (10.5, 12.1667, "高等数学（同济版）B(1) · 天山堂 A201"),
        (12.1667, 12.5, "午餐"),
        (12.5167, 12.9167, "午睡"),
        (14.5, 18.1667, "普通物理（理工版） · 天山堂 A501"),
        (18.1667, 18.6667, "晚餐"),
        (21.0, 21.5, "跑步"),
        (21.5, 22.0, "洗澡/护肤"),
        (22.0, 23.5, "放松/看剧"),
    ],
    "周六": [
        (0.0, 7.5, "睡眠"),
        (7.5, 8.1667, "起床/洗漱/早餐"),
        (8.5, 12.0, "自由活动（上午）"),
        (12.1667, 12.5, "午餐"),
        (12.5167, 12.9167, "午睡"),
        (13.0, 17.5, "娱乐/出行/打球"),
        (18.0, 18.6667, "晚餐"),
        (21.0, 21.5, "跑步"),
        (21.5, 22.0, "洗澡/护肤"),
        (22.0, 23.5, "阅读/放松"),
    ],
    "周日": [
        (0.0, 7.5, "睡眠"),
        (7.5, 8.0, "起床/洗漱/早餐"),
        (8.5, 12.0, "复习/预习"),
        (12.1667, 12.5, "午餐"),
        (12.5167, 12.9167, "午睡"),
        (13.0, 17.5, "娱乐/学习平衡"),
        (18.0, 18.6667, "晚餐"),
        (19.0, 21.0, "娱乐"),
        (21.5, 22.0, "洗漱/护肤"),
        (22.0, 23.5, "总结一周/规划"),
    ],
}

# ===== 类型到颜色的映射函数 =====
def color_for_type(desc):
    if ("程序设计" in desc or "高等" in desc or "普通物理" in desc or "数学" in desc or "信息科学" in desc or "思想道德" in desc):
        return "red"
    if desc == "睡眠":
        return "gray"
    if desc in ("自习", "预习", "复习"):
        return "blue"
    if desc in ("午餐", "晚餐", "午睡"):
        return "orange"
    if "娱乐" in desc or desc == "放松":
        return "green"
    return "black"

# ===== 创建 Event =====
def make_event(start_date, day_offset, start_h, end_h, desc):
    ev = Event()
    date = start_date + datetime.timedelta(days=day_offset)
    if end_h >= start_h:
        dtstart = datetime.datetime(date.year, date.month, date.day,
                                    int(start_h), int((start_h - int(start_h)) * 60),
                                    tzinfo=tz)
        dtend   = datetime.datetime(date.year, date.month, date.day,
                                    int(end_h), int((end_h - int(end_h)) * 60),
                                    tzinfo=tz)
    else:
        dtstart = datetime.datetime(date.year, date.month, date.day,
                                    int(start_h), int((start_h - int(start_h)) * 60),
                                    tzinfo=tz)
        next_day = date + datetime.timedelta(days=1)
        dtend = datetime.datetime(next_day.year, next_day.month, next_day.day,
                                  int(end_h), int((end_h - int(end_h)) * 60),
                                  tzinfo=tz)

    ev.add("dtstart", dtstart)
    ev.add("dtend", dtend)
    ev.add("summary", desc)

    # 设置颜色属性
    ev.add("COLOR", color_for_type(desc))

    return ev

# ===== 生成 ICS 文件 =====
def generate_ics(filename, schedule, start_date, is_repeat=True):
    cal = Calendar()
    cal.add("prodid", "-//LZU 作息表//")
    cal.add("version", "2.0")

    wkmap = {"周一":0, "周二":1, "周三":2, "周四":3, "周五":4, "周六":5, "周日":6}

    for dayname, evs in schedule.items():
        offset = wkmap[dayname]
        evs_sorted = sorted(evs, key=lambda t: t[0])
        filled = []
        filled.append(evs_sorted[0])
        for i in range(1, len(evs_sorted)):
            prev = evs_sorted[i-1]
            curr = evs_sorted[i]
            if curr[0] - prev[1] >= 0.5:
                filled.append((prev[1], curr[0], "自习"))
            filled.append(curr)
        for (st, en, desc) in filled:
            ev = make_event(start_date, offset, st, en, desc)
            if is_repeat:
                ev.add("rrule", {"freq": "weekly", "interval": 2})
            cal.add_component(ev)

    with open(filename, "wb") as f:
        f.write(cal.to_ical())
    print("✅ ICS 文件已生成:", filename)

if __name__ == "__main__":
    generate_ics("单周作息_colored.ics", single_week, semester_start_single, True)
    generate_ics("双周作息_colored.ics", double_week, semester_start_double, True)
